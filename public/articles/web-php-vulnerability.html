<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>phpæ¼æ´</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
</head>
<body>
<div class="article-content" data-id="web-php-vulnerability">
<div class="intro-article">
<h1>let us begin!ğŸ˜</h1>
<p>æºç :</p>
<pre><code class="language-php">&lt;?php
highlight_file(__FILE__);
include_once('flag.php');
if(isset($_POST['a'])&amp;&amp;!preg_match('/[0-9]/',$_POST['a'])&amp;&amp;intval($_POST['a'])){
Â Â Â Â if(isset($_POST['b1'])&amp;&amp;$_POST['b2']){
Â Â Â Â Â Â Â Â if($_POST['b1']!=$_POST['b2']&amp;&amp;md5($_POST['b1'])===md5($_POST['b2'])){
Â Â Â Â Â Â Â Â Â Â Â Â if($_POST['c1']!=$_POST['c2']&amp;&amp;is_string($_POST['c1'])&amp;&amp;is_string($_POST['c2'])&amp;&amp;md5($_POST['c1'])==md5($_POST['c2'])){
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â echoÂ $flag;
Â Â Â Â Â Â Â Â Â Â Â Â }else{
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â echoÂ &quot;yee&quot;;
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â }else{
Â Â Â Â Â Â Â Â Â Â Â Â echoÂ &quot;nop&quot;;
Â Â Â Â Â Â Â Â }
Â Â Â Â }else{
Â Â Â Â Â Â Â Â echoÂ &quot;goÂ on&quot;;
Â Â Â Â }
}else{
Â Â Â Â echoÂ &quot;let'sÂ getÂ someÂ php&quot;;
}
?&gt;
</code></pre>
<p><span style="color:#51cf66">my writeup and thought</span></p>
<h2><strong>1</strong></h2>
<pre><code class="language-php"> isset($_POST['a']) &amp;&amp; !preg_match('/[0-9]/', $_POST['a']) &amp;&amp; intval($_POST&gt; ['a']) 
</code></pre>
<p>è€ƒå¯Ÿ<strong>æ­£åˆ™è¡¨è¾¾å¼</strong></p>
<p>æäº¤ a[]=6(æ•°ç»„)ä¼šè®© preg_match åœ¨ä¼ æ•°ç»„æ—¶äº§ç”Ÿ warning å¹¶è¿”å› false</p>
<p>å› æ­¤ !preg_match ä¸º true</p>
<p>intval(array) åœ¨å¸¸è§ PHP ç‰ˆæœ¬ä¸‹ä¸ä¼šæŠ›è‡´å‘½é”™è¯¯ï¼Œç»“æœä¸º 1 / truthy ï¼ˆä»æœ‰ warningï¼‰</p>
<p>å› æ­¤æ•´è¡Œæˆç«‹!</p>
<h2><strong>2</strong></h2>
<pre><code class="language-php">isset($_POST['b1']) &amp;&amp; $_POST['b2']
</code></pre>
<p>åªæ£€æŸ¥ b1 æ˜¯å¦è®¾ç½®ä¸” $_POST[â€˜b2â€™] ä¸º truthyï¼ˆæ²¡æœ‰ issetï¼‰</p>
<p>æäº¤ b1[]=hello ä¸ b2[]=hackerï¼ˆä¸åŒæ•°ç»„ï¼‰å³å¯æ»¡è¶³!</p>
<h2><strong>3</strong></h2>
<pre><code class="language-php">$_POST['b1'] != $_POST['b2'] &amp;&amp; md5($_POST['b1']) === md5($_POST['b2'])
</code></pre>
<p>b1 != b2ï¼šä¸åŒæ•°ç»„äº’ä¸ç›¸ç­‰ï¼Œæˆç«‹ã€‚</p>
<p>ä¼ æ•°ç»„ç»™ md5() ä¼šäº§ç”Ÿ warning å¹¶è¿”å› NULLï¼ˆæˆ–éå­—ç¬¦ä¸²ï¼‰</p>
<p>æ‰€ä»¥ NULL === NULL ä¸ºçœŸ!</p>
<p>å³åˆ©ç”¨äº†å¯¹ä¸æ­£ç¡®ç±»å‹æ²¡æœ‰ç±»å‹æ£€æŸ¥çš„è¡Œä¸º!</p>
<h2><strong>4</strong></h2>
<pre><code class="language-php">$_POST['c1'] != $_POST['c2'] &amp;&amp; is_string($_POST['c1']) &amp;&amp; is_string($_POST['c2']) &amp;&amp; md5($_POST['c1']) == md5($_POST['c2'])
</code></pre>
<p>è¿™é‡Œè¦æ±‚ c1 å’Œ c2 æ˜¯å­—ç¬¦ä¸²ï¼ˆis_stringï¼‰ï¼Œä¸”ä¸¤è€…ä¸ç›¸ç­‰</p>
<p>ä½† md5(â€¦) == md5(â€¦)ï¼ˆæ³¨æ„æ˜¯<strong>å®½æ¾æ¯”è¾ƒ</strong> ==ï¼‰ä¸ºçœŸ</p>
<p>è¿™æ˜¯ç»å…¸çš„ PHP â€œmagic hashâ€ æ¼æ´åˆ©ç”¨ç‚¹ï¼š</p>
<p>å¦‚æœä¸¤ä¸ªä¸åŒå­—ç¬¦ä¸²çš„ md5 éƒ½å½¢å¦‚ â€œ0eâ€¦å…¨æ˜¯æ•°å­—â€¦â€ï¼ˆä¾‹å¦‚ â€œ0e46209â€¦â€ï¼‰</p>
<p>åœ¨ PHP çš„å®½æ¾æ¯”è¾ƒ == ä¸‹ä¼šè¢«å½“åš<strong>ç§‘å­¦è®¡æ•°æ³•</strong>ï¼ˆ0eâ€¦ï¼‰å¹¶è¢«è§£æä¸ºæ•°å­— 0ï¼Œä»è€Œè®¤ä¸ºç›¸ç­‰</p>
<p>å¸¸è§çš„å¯ç”¨ pair(å†å²ä¸Šå¹¿ä¸ºäººçŸ¥çš„â€œmagic hashâ€ç¤ºä¾‹):</p>
<p>c1 = 240610708</p>
<p>c2 = QNKCDZO</p>
<p>è¿™ä¸¤ä¸ªå­—ç¬¦ä¸²äº’ä¸ç›¸åŒ</p>
<p>ä½†æ˜¯!</p>
<p>md5(â€œ240610708â€) ä¸ md5(â€œQNKCDZOâ€) éƒ½ä»¥ 0eâ€¦ å¼€å¤´(éƒ½æ˜¯å…¨æ•°å­—å°¾)</p>
<p>ç”¨ == æ¯”è¾ƒä¼šè¢«å½“ä½œ 0ï¼Œæ‰€ä»¥ md5(c1) == md5(c2) ä¸ºçœŸ!</p>
<p>å› æ­¤æŠŠ c1 ä¸ c2 èµ‹ä¸ºä¸Šé¢è¿™æ ·çš„â€œ<strong>magic hash</strong>â€å­—ç¬¦ä¸²å³å¯!</p>
<p>æœ€ç»ˆpayload:</p>
<p>curl -s -X POST \</p>
<p>-d â€œa[]=6â€ \</p>
<p>-d â€œb1[]=helloâ€ \</p>
<p>-d â€œb2[]=hackerâ€ \</p>
<p>-d â€œc1=240610708â€ \</p>
<p>-d â€œc2=QNKCDZOâ€ \</p>
<p><a href="http://target/">http://target/</a></p>
<p>å¾—åˆ°<em><strong>flag</strong></em></p>
<p>flag{1c29f312-3f3b-4ccb-9963-5ed647525f92}</p>
<p>perfect!ğŸ˜</p>
<blockquote>
<p>å¤ç›˜</p>
</blockquote>
<p>é˜²å¾¡å»ºè®®(å­¦ä¹ æ€è€ƒä¸€ä¸‹)ğŸ˜</p>
<p>1.ä¸¥æ ¼ç±»å‹æ£€æŸ¥è¾“å…¥ï¼š</p>
<p>å…ˆç”¨ is_string() / is_numeric() / is_array() ç­‰åˆ¤æ–­ç±»å‹</p>
<p>æˆ–è€…ä½¿ç”¨ filter_input(INPUT_POST, â€˜aâ€™, FILTER_VALIDATE_INT) ç­‰è¿‡æ»¤å™¨</p>
<p>2.ä¸è¦å¯¹æ¥æºä¸æ˜çš„å€¼ç›´æ¥ç”¨äº string-only å‡½æ•°ï¼š</p>
<p>åœ¨è°ƒç”¨ preg_match, md5, intval å‰ç¡®ä¿æ˜¯<em>å­—ç¬¦ä¸²</em>æˆ–<em>æ•´å‹</em>ã€‚</p>
<p>ä¾‹å¦‚ï¼šif (!is_string($_POST[â€˜aâ€™])) { /* reject */ }</p>
<blockquote>
<p>æ°¸è¿œä¸è¦ç›¸ä¿¡ç”¨æˆ·çš„è¾“å…¥!!!</p>
</blockquote>
<p>3.æ¯”è¾ƒå“ˆå¸Œæ—¶ä½¿ç”¨ hash_equals ä¸<strong>ä¸¥æ ¼æ¯”è¾ƒ</strong>ï¼ˆå¹¶ç¡®ä¿éƒ½æ˜¯å­—ç¬¦ä¸²ï¼‰ï¼š</p>
<pre><code class="language-php">if (is_string($h1) &amp;&amp; is_string($h2) &amp;&amp; hash_equals($h1, $h2)) { ... }
</code></pre>
<p>hash_equals é˜²æ­¢æ—¶åºæ”»å‡»å¤–ï¼ŒåŠ ä¸Š is_string å¯é¿å… 0eâ€¦ å®½æ¾æ¯”è¾ƒé—®é¢˜ã€‚</p>
<p>4.é¿å…ä½¿ç”¨ == æ¯”è¾ƒæ•£åˆ—ï¼Œåº”è¯¥ç”¨ === æˆ– hash_equalsã€‚</p>
<p>5.ä¸è¦ä¾èµ– intval() å¯¹ä¸ç¡®å®šç±»å‹è¿›è¡Œ truthy æ£€æŸ¥</p>
<p>å¯¹æ•°å­—è¯·å…ˆéªŒè¯ ctype_digit æˆ– filter_var(â€¦, FILTER_VALIDATE_INT)ã€‚</p>
<p>6.æ˜¾ç¤º/è®°å½• warnings è€Œä¸æ˜¯é™é»˜å¿½ç•¥ï¼Œå¹¶åœ¨ç”Ÿäº§ç¯å¢ƒç¦ç”¨ display_errors</p>
<p>ä½†ç¡®ä¿æ—¥å¿—è®°å½•ç”¨äº<strong>å®‰å…¨å®¡è®¡</strong>ã€‚</p>
<p>7.ç»Ÿä¸€è¾“å…¥å¤„ç†å±‚ï¼šæŠŠæ‰€æœ‰ POST è¾“å…¥è§„èŒƒåŒ–æˆä½ æœŸæœ›çš„ç±»å‹ï¼ˆä¾‹å¦‚ä¸€å¾‹å–å­—ç¬¦ä¸²æˆ–æ•°ç»„ï¼‰</p>
<blockquote>
<p>æ‹’ç»éæœŸæœ›ç±»å‹ã€‚</p>
</blockquote>
<p>å®‰å…¨ä»£ç ç¤ºä¾‹:ğŸ˜‹</p>
<pre><code class="language-php">&lt;?php
highlight_file(__FILE__);
include_once('flag.php');
function get_post_string($key) {
    if (!isset($_POST[$key])) return null;
    if (!is_string($_POST[$key])) return null;
    return $_POST[$key];
}
$a = get_post_string('a');
$b1 = get_post_string('b1');
$b2 = get_post_string('b2');
$c1 = get_post_string('c1');
$c2 = get_post_string('c2');

if ($a !== null &amp;&amp; preg_match('/^[0-9]+$/', $a) &amp;&amp; intval($a) !== 0) {
    if ($b1 !== null &amp;&amp; $b2 !== null) {
        if ($b1 !== $b2 &amp;&amp; hash_equals(md5($b1), md5($b2))) {
            if ($c1 !== $c2 &amp;&amp; hash_equals(md5($c1), md5($c2))) {
                echo $flag;
            } else {
                echo &quot;yee&quot;;
            }
        } else {
            echo &quot;nop&quot;;
        }
    } else {
        echo &quot;go on&quot;;
    }
} else {
    echo &quot;let's get some php&quot;;
}
?&gt;
</code></pre>
<p>over~ğŸ¥¸</p>
<p>æ„Ÿè°¢é˜…è¯»ï¼ğŸ¥¸</p>
<p>å˜€å’•:æ’ç‰ˆçœŸç´¯â€¦ğŸ˜‡</p>
</div>
</div>
</body>
</html>